name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
    
    - name: Build executable
      run: |
        pyinstaller --onefile --windowed --name=Run8ControlConductor --hidden-import=pygame --hidden-import=tkinter --hidden-import=tkinter.ttk --hidden-import=tkinter.messagebox --hidden-import=tkinter.filedialog --collect-all=pygame main.py
    
    - name: Create release package
      run: |
        mkdir release
        copy dist\Run8ControlConductor.exe release\
        copy README.md release\
        copy LICENSE release\
        copy CHANGELOG.md release\
        copy release\QUICK_START_GUIDE.md release\ 2>NUL || echo "Quick start guide not found"
        copy release\README.txt release\ 2>NUL || echo "Release readme not found"
        copy release\"Start Run8 Control Conductor.bat" release\ 2>NUL || echo "Batch file not found"
        
    - name: Create ZIP archive
      run: |
        Compress-Archive -Path release\* -DestinationPath Run8ControlConductor-${{ github.ref_name }}.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          Run8ControlConductor-${{ github.ref_name }}.zip
          release/Run8ControlConductor.exe
        body: |
          ## Run8 Control Conductor ${{ github.ref_name }}
          
          ### ðŸš€ Quick Start for New Users
          1. Download `Run8ControlConductor.exe` below
          2. Double-click to run (no installation required)
          3. Follow the in-app instructions to map your controller
          
          ### ðŸ“¦ What's Included
          - **Run8ControlConductor.exe** - Standalone executable (no Python required)
          - **Run8ControlConductor-${{ github.ref_name }}.zip** - Complete package with documentation
          
          ### ðŸ“‹ System Requirements
          - Windows 10/11 (64-bit)
          - Run8 Train Simulator
          - USB joystick/gamepad
          
          ### ðŸ”§ First Time Setup
          1. Connect your joystick/gamepad
          2. Run the executable
          3. Click "Refresh Devices" to detect your controller
          4. Enable your controller by checking the box
          5. Map controls using "Map Input" buttons
          6. Click "Start" to begin using your controller with Run8
          
          For detailed instructions, see the documentation in the ZIP file.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
